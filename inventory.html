<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Inventory - XNO-RY</title>
<style>
body { 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background: #f5f5f5;
    color: #333;
}
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}
nav {
    margin-bottom: 20px;
    text-align: right;
}
nav a {
    color: #333;
    text-decoration: none;
    margin: 0 10px;
    font-weight: bold;
}
nav a:hover {
    color: #4CAF50;
}
h1 {
    margin: 0 0 20px;
    font-size: 24px;
    font-weight: 600;
}
.section-title {
    color: #333;
    font-size: 20px;
    margin: 30px 0 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #eee;
}
.table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    border-radius: 4px;
    overflow: hidden;
    margin: 20px 0;
}
.table th {
    background: #f8f9fa;
    font-weight: 600;
    text-align: left;
    padding: 12px;
    border-bottom: 2px solid #dee2e6;
}
.table td {
    padding: 12px;
    border-bottom: 1px solid #dee2e6;
}
.table tr:last-child td {
    border-bottom: none;
}
.stock-adjustment {
    display: flex;
    gap: 8px;
    align-items: center;
}
.stock-adjustment select,
.stock-adjustment input {
    padding: 6px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
}
.stock-adjustment input {
    width: 80px;
}
.btn {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.2s;
}
.btn:hover {
    background: #45a049;
}
.config-form {
    background: white;
    padding: 20px;
    border-radius: 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    display: grid;
    grid-template-columns: auto 1fr auto 1fr auto 1fr auto;
    gap: 15px;
    align-items: center;
}
.config-form input {
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    width: 80px;
}
.config-form label {
    color: #555;
    font-weight: 500;
}
.opened {
    margin-top: 15px;
    padding: 12px;
    border-radius: 4px;
    background: #e8f5e9;
    border: 1px solid #c8e6c9;
    color: #2e7d32;
}
</style>
</head>
<body>
<div class="container">
  <nav>
    <a href="index.html">Shop</a>
    <a href="cart.html">Cart</a>
    <a href="backpack.html">Backpack</a>
    <a href="inventory.html">Admin Panel</a>
  </nav>

  <h1>XNO-RY Store</h1>
  <h2 class="section-title">Product Inventory & Stock Management</h2>

  <div class="table-container">
    <table class="table" id="inventory-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Product Name</th>
          <th>Common Stock</th>
          <th>Rare Stock</th>
          <th>Secret Stock</th>
          <th>Adjust Stock (Rarity/Amount)</th>
        </tr>
      </thead>
      <tbody>
        </tbody>
    </table>
  </div>

  <h2 class="section-title">Rarity Probability Config</h2>
  <div class="config-form">
    <label for="prob-common">Common (%):</label>
    <input type="number" id="prob-common" min="0" max="100" />
    <label for="prob-rare">Rare (%):</label>
    <input type="number" id="prob-rare" min="0" max="100" />
    <label for="prob-secret">Secret (%):</label>
    <input type="number" id="prob-secret" min="0" max="100" />
    <button id="save-probs" class="btn">Save Probabilities</button>
  </div>
  <div id="result" class="opened" style="display: none;"></div>

</div>

<script>
const apiRoot = 'http://localhost:3000';

async function load() {
  const res = await fetch(apiRoot + '/api/products');
  const products = (await res.json()).data;
  const tbody = document.getElementById('inventory-table').querySelector('tbody');
  tbody.innerHTML = '';
  
  const inventoryRes = await fetch(apiRoot + '/api/products');
  const inventoryData = (await inventoryRes.json()).data;
  const rawProductsRes = await fetch(apiRoot + '/api/products');
  const rawProducts = (await rawProductsRes.json()).data;


  rawProducts.forEach(p => {
    const row = tbody.insertRow();
    const stocks = p.stocks || { common:0, rare:0, secret:0 };

    row.insertCell().textContent = p.id;
    row.insertCell().textContent = p.name;
    row.insertCell().textContent = stocks.common;
    row.insertCell().textContent = stocks.rare;
    row.insertCell().textContent = stocks.secret;
    
    const controlsCell = row.insertCell();
    controlsCell.innerHTML = `
      <div class="stock-adjustment">
        <select data-id="${p.id}" class="rarity-select">
          <option value="common">Common</option>
          <option value="rare">Rare</option>
          <option value="secret">Secret</option>
        </select>
        <input type="number" value="1" min="-100" class="amount-input" data-id="${p.id}" />
        <button class="adjust-stock-btn btn" data-id="${p.id}">Adjust</button>
        </div>
    `;

    controlsCell.querySelector('.adjust-stock-btn').addEventListener('click', async (e) => {
        const id = e.target.dataset.id;
        const rarity = controlsCell.querySelector('.rarity-select').value;
        const amount = controlsCell.querySelector('.amount-input').value;

        const res = await fetch(apiRoot + `/api/inventory/${id}/stock`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ rarity, amount })
        }).then(r => r.json());

        if (res.error) {
            document.getElementById('result').textContent = 'Error: ' + res.error; 
            document.getElementById('result').style.display = 'block';
            return; 
        }
        document.getElementById('result').textContent = `Stock for ${rarity} updated successfully.`;
        document.getElementById('result').style.display = 'block';
        load();
    });
  });
}

async function loadProbs(){
  const res = await fetch(apiRoot + '/api/config');
  const j = await res.json();
  const p = j.data || { common:60,rare:30,secret:10 };
  document.getElementById('prob-common').value = p.common;
  document.getElementById('prob-rare').value = p.rare;
  document.getElementById('prob-secret').value = p.secret;
}

document.getElementById('save-probs').addEventListener('click', async ()=>{
  const payload = { common: parseInt(document.getElementById('prob-common').value)||0, rare: parseInt(document.getElementById('prob-rare').value)||0, secret: parseInt(document.getElementById('prob-secret').value)||0 };

  const sum = payload.common + payload.rare + payload.secret;
  if(sum !== 100) {
      alert(`Error: Total probability must be 100. Current total is ${sum}.`);
      return;
  }
  
  const res = await fetch(apiRoot + '/api/config', { method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload) });
  const j = await res.json();
  if(j.error){ 
      document.getElementById('result').textContent = 'Error: '+j.error; 
      document.getElementById('result').style.display = 'block';
      return;
  }
  document.getElementById('result').textContent = 'Probabilities saved successfully!';
  document.getElementById('result').style.display = 'block';
});

document.addEventListener('DOMContentLoaded', ()=>{
  load();
  loadProbs();
});
</script>
</body>
</html>